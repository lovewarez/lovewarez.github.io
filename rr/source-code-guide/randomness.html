<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Randomness - RuggRogue Source Code Guide</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Design and source code breakdown of a simple roguelike">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="book/outlink.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="dependencies.html"><strong aria-hidden="true">1.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="source-code-layout.html"><strong aria-hidden="true">2.</strong> Source Code Layout</a></li><li class="chapter-item expanded "><a href="overall-game-flow.html"><strong aria-hidden="true">3.</strong> Overall Game Flow</a></li><li class="chapter-item expanded "><a href="event-handling.html"><strong aria-hidden="true">4.</strong> Event Handling</a></li><li class="chapter-item expanded "><a href="rendering.html"><strong aria-hidden="true">5.</strong> Rendering</a></li><li class="chapter-item expanded "><a href="user-interface.html"><strong aria-hidden="true">6.</strong> User Interface</a></li><li class="chapter-item expanded "><a href="options.html"><strong aria-hidden="true">7.</strong> Options</a></li><li class="chapter-item expanded "><a href="word-wrapping.html"><strong aria-hidden="true">8.</strong> Word Wrapping</a></li><li class="chapter-item expanded "><a href="entity-component-system.html"><strong aria-hidden="true">9.</strong> Entity Component System</a></li><li class="chapter-item expanded "><a href="game-data.html"><strong aria-hidden="true">10.</strong> Game Data</a></li><li class="chapter-item expanded "><a href="saving-and-loading.html"><strong aria-hidden="true">11.</strong> Saving and Loading</a></li><li class="chapter-item expanded "><a href="field-of-view.html"><strong aria-hidden="true">12.</strong> Field of View</a></li><li class="chapter-item expanded "><a href="pathfinding.html"><strong aria-hidden="true">13.</strong> Pathfinding</a></li><li class="chapter-item expanded "><a href="randomness.html" class="active"><strong aria-hidden="true">14.</strong> Randomness</a></li><li class="chapter-item expanded "><a href="map-generation.html"><strong aria-hidden="true">15.</strong> Map Generation</a></li><li class="chapter-item expanded "><a href="map-population.html"><strong aria-hidden="true">16.</strong> Map Population</a></li><li class="chapter-item expanded "><a href="auto-run.html"><strong aria-hidden="true">17.</strong> Auto-Run</a></li><li class="chapter-item expanded "><a href="turn-order-and-combat.html"><strong aria-hidden="true">18.</strong> Turn Order and Combat</a></li><li class="chapter-item expanded "><a href="items.html"><strong aria-hidden="true">19.</strong> Items</a></li><li class="chapter-item expanded "><a href="hunger-and-regeneration.html"><strong aria-hidden="true">20.</strong> Hunger and Regeneration</a></li><li class="chapter-item expanded "><a href="experience-and-difficulty.html"><strong aria-hidden="true">21.</strong> Experience and Difficulty</a></li><li class="chapter-item expanded "><a href="monsters.html"><strong aria-hidden="true">22.</strong> Monsters</a></li><li class="chapter-item expanded "><a href="new-game-plus.html"><strong aria-hidden="true">23.</strong> New Game Plus</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RuggRogue Source Code Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="randomness"><a class="header" href="#randomness">Randomness</a></h1>
<p>RuggRogue is a roguelike, and the signature feature of roguelikes is the use of procedural content generation: levels, items and enemy placement differ from play to play.
This is typically achieved through the use of a <em>random number generator</em> (or <em>RNG</em>).
This chapter will cover generation, usage and considerations of random numbers by RuggRogue.</p>
<h2 id="generating-random-numbers"><a class="header" href="#generating-random-numbers">Generating Random Numbers</a></h2>
<p>Roguelikes typically get their random numbers from what's called a <em>pseudo-random number generator</em> (or <em>PRNG</em>).
&quot;Pseudo&quot; means &quot;fake&quot;, so a PRNG produces a <em>deterministic</em> series of numbers that just happen to look random enough for the purposes of a computer game.
RuggRogue takes advantage of this determinism.
Most roguelikes just initialize a single PRNG, hang onto it and share it across the whole game logic.
RuggRogue instead creates <em>temporary</em> PRNGs whenever some code needs random numbers and discards those PRNGs afterwards.
By carefully controlling how these PRNGs are initialized we can achieve <em>seeded games</em>, where two games with the same seed produce the same dungeon and spawns.
Seeded games are useful for debugging and play-testing, and can be fun for players to mess around with.</p>
<p>The nuts and bolts of generating random numbers is handled via external crates: <a href="https://crates.io/crates/rand">rand</a>, <a href="https://crates.io/crates/rand_xoshiro">rand_xoshiro</a> and <a href="https://crates.io/crates/wyhash">wyhash</a>.
rand provides a convenient interface to make use of random numbers generated from a backend source crate.
rand_xoshiro is a fast PRNG that provides the actual random numbers.
wyhash is a hasher that takes input values and produces seed values to initialize PRNGs.
These three crates serve as the foundation of all of the randomness in RuggRogue.</p>
<p>A PRNG is initialized with a seed value that determines the sequence of random numbers that will be produced, so the first step in generating random numbers is to create this seed value.
These seed values are created by combining the following input values using wyhash:</p>
<ol>
<li>A unique magic number.</li>
<li>The game seed.</li>
<li>Any other relevant differentiating input values.</li>
</ol>
<p>Each place in the code that needs random numbers starts by feeding a magic number into a wyhash hasher.
Each magic number is an arbitrary number that is used in only one place in the code, the values of which can be found in the <code>src/magicnum.rs</code> file:</p>
<pre><code class="language-rust ignore">///! Arbitrary constants to seed hashers whose output is in turn used to seed RNGs.

pub const GENERATE_ROOMS_AND_CORRIDORS: u64 = 0x3fdc77fb4d7f5d2f;
pub const SPAWN_GUARANTEED_WEAPON: u64 = 0x67caf3e7b16e9df2;
pub const SPAWN_GUARANTEED_ARMOR: u64 = 0x74e90549dbcadfd0;
pub const FILL_ROOM_WITH_SPAWNS: u64 = 0xd85af3d2cf6dcbc5;
pub const MELEE_ATTACK: u64 = 0x258890651a33d5d;
</code></pre>
<p>Since there are five magic number constants, there are five unique places in the code where PRNGs are created.
The fact that the magic numbers have different values helps to avoid the same seed being used by different PRNGs, which would otherwise produce the same random number sequence.</p>
<p>The game seed is a unique number associated with a game that is the sole reason that different games have different dungeon layouts and outcomes.
The initial game seed value can be provided as a command line argument or randomly generated as needed; this is one of the first things done in the <code>main</code> entry point function in the <code>src/main.rs</code> file.
Starting a new game causes that game to adopt that initial value as that game's seed; this value is preserved across saves and loads.
If the player returns to the title screen for whatever reason, the initial game seed value is changed into another random value to avoid accidentally playing the same dungeon again.</p>
<p>With the magic number and game seed fed into the hasher, the final thing the hasher needs is some relevant differentiating input values.
For example, the PRNG associated with <code>GENERATE_ROOMS_AND_CORRIDORS</code> provides the dungeon depth so that depth 2 has a different layout to depth 1.</p>
<p>The final hash value is then used as the seed for that particular PRNG.
Here's a code excerpt for <code>GENERATE_ROOMS_AND_CORRIDORS</code> from the <code>src/map.rs</code> file that demonstrates initializing a PRNG from hashed input values:</p>
<pre><code class="language-rust ignore">use rand::SeedableRng;
use rand_xoshiro::Xoshiro128PlusPlus as GameRng;
use std::hash::Hasher;
use wyhash::WyHash;

use crate::{magicnum, GameSeed};

pub fn generate_rooms_and_corridors(/* ... */) {
    // ...

    let mut rng = {
        let mut hasher = WyHash::with_seed(magicnum::GENERATE_ROOMS_AND_CORRIDORS);
        hasher.write_u64(game_seed.0);
        hasher.write_i32(map.depth);
        GameRng::seed_from_u64(hasher.finish())
    };

    // Use rng to get random numbers...
}
</code></pre>
<h2 id="uses-of-random-numbers"><a class="header" href="#uses-of-random-numbers">Uses of Random Numbers</a></h2>
<p>RuggRogue uses random numbers to control map generation, monster and item spawns and combat outcomes.</p>
<h3 id="map-generation"><a class="header" href="#map-generation">Map Generation</a></h3>
<p>The PRNG for map generation is initialized in the <code>generate_rooms_and_corridors</code> function in the <code>src/map.rs</code> file with the help of:</p>
<ul>
<li><code>magicnum::GENERATE_ROOMS_AND_CORRIDORS</code></li>
<li>The game seed.</li>
<li>The dungeon depth for that map.</li>
</ul>
<p>This PRNG determines:</p>
<ul>
<li>the position and size of rooms,</li>
<li>whether to connect rooms with a horizontal corridor followed by a vertical corridor or vice versa, and</li>
<li>which pairs of rooms are connected with additional corridors beyond the minimum required to connect all of the rooms together.</li>
</ul>
<h3 id="monster-and-item-spawns"><a class="header" href="#monster-and-item-spawns">Monster and Item Spawns</a></h3>
<p>The main PRNG for determining monster and item spawns is initialized in the <code>fill_rooms_with_spawns</code> function in the <code>src/spawn.rs</code> file with the help of:</p>
<ul>
<li><code>magicnum::FILL_ROOM_WITH_SPAWNS</code></li>
<li>The game seed.</li>
<li>The dungeon depth of the map being filled with spawns.</li>
</ul>
<p>This PRNG determines:</p>
<ul>
<li>the placement of the starting weapon and armor in the room that the player starts in,</li>
<li>the placement of the guaranteed ration on each level,</li>
<li>whether a room should spawn items and where they should be placed,</li>
<li>whether a spawned item should be equipment or consumable,</li>
<li>whether spawned equipment should be a weapon or armor,</li>
<li>the exact type of a spawned consumable item,</li>
<li>the random extra bonus for spawned weapons and armors, and whether to round fractional power values up or down,</li>
<li>whether a room should spawn monsters and where they should be placed, and</li>
<li>the power levels of spawned monsters, and whether to round fractional power values up or down.</li>
</ul>
<p>The game makes use of two additional PRNGs to periodically spawn guaranteed weapons and armors beyond the first level.
Both of these PRNGs exist in the <code>spawn_guaranteed_equipment</code> function in the <code>src/spawn.rs</code> file.
The PRNG for spawning guaranteed weapons is initialized with:</p>
<ul>
<li><code>magicnum::SPAWN_GUARANTEED_WEAPON</code></li>
<li>The game seed.</li>
<li>The sum of the dungeon depth and the numeric value of the low four bytes of the game seed, all divided by four.</li>
</ul>
<p>The division by four in the last value causes each sequence of four adjacent levels to seed the guaranteed weapon PRNG with the same value and thus produce the same random number sequence.
This allows those levels to effectively share the same PRNG sequence so that only one of those levels will spawn a guaranteed weapon.
The four bytes of game seed adjusts the offset of the levels so the depth sequences aren't just 1-4, 5-8, etc. for every single game.</p>
<p>The initialization of the PRNG to determine guaranteed armor spawning is identical to that of the guaranteed weapon, except for the use of <code>magicnum::SPAWN_GUARANTEED_ARMOR</code> and the use of the high four bytes of the game seed instead of the low four bytes.</p>
<h3 id="combat-outcomes"><a class="header" href="#combat-outcomes">Combat Outcomes</a></h3>
<p>The combat PRNG exists in the <code>melee_attack</code> function in the <code>src/damage.rs</code> file, and is initialized with the help of:</p>
<ul>
<li><code>magicnum::MELEE_ATTACK</code></li>
<li>The game seed.</li>
<li>The current turn count.</li>
<li>The x and y coordinates of the attacker.</li>
<li>The x and y coordinates of the defender.</li>
</ul>
<p>The combat PRNG determines:</p>
<ul>
<li>whether the melee attack hits or misses, assuming the defender is not asleep,</li>
<li>whether to fluctuate damage, and if so, whether to modify it plus or minus 50%, and</li>
<li>whether to round fractional damage values up or down to the nearest whole number.</li>
</ul>
<h2 id="ensuring-identical-randomness-with-native-and-web-builds"><a class="header" href="#ensuring-identical-randomness-with-native-and-web-builds">Ensuring Identical Randomness with Native and Web Builds</a></h2>
<p>In the course of testing, I noticed that there were differences between the native and web versions of the game with the presence and placement of monsters and items, given the same game seed.
This meant that the same game seed was causing different random numbers to be produced by the same PRNG across the two builds!</p>
<p>After a lot of debugging, I discovered that this was due to the native and web builds pulling out different amounts of data from the PRNGs.
This divergence comes from pulling a <code>usize</code> from a PRNG; this is 64 bits on the <code>x86_64</code> architecture of the native build, but only 32 bits on the <code>wasm32</code> architecture of the web build.
Replacing the <code>usize</code> with a <code>u32</code> fixes the issue, but where this fix is needed can be pretty subtle.
For example, can you spot the problem here?</p>
<pre><code class="language-rust ignore">let num = rng.gen_range(1..2);

for pos in room.iter_xy().choose_multiple(rng, num) {
    spawn_random_item_at(world, rng, pos);
}
</code></pre>
<p>In the above code, the <code>num</code> variable is inferred by Rust to be of the <code>usize</code> type due to the lack of type annotations and the fact that it's the type of the second argument of the <code>choose_multiple</code> function.
This causes <code>rng.gen_range(1..2)</code> to produce different values for the native and web versions of the game.
Annotating the <code>1..2</code> input with an integer type of a fixed size resolves the issue:</p>
<pre><code class="language-rust ignore">let num = rng.gen_range(1i32..2i32);

for pos in room.iter_xy().choose_multiple(rng, num as usize) {
    spawn_random_item_at(world, rng, pos);
}
</code></pre>
<p>The use of <code>rng.gen_range(1i32..2i32)</code> extracts a 32-bit <code>i32</code> value on both the <code>x86_64</code> and <code>wasm32</code> architectures.
Note that the <code>num</code> variable above is now also of type <code>i32</code>, so it needs to be cast into <code>usize</code> when being passed into the <code>choose_multiple</code> function.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>This chapter serves as a high-level overview of RuggRogue's approach to generating and using random numbers.
The biggest thing to take away from all of this is the focus on determinism by seeding PRNGs with the hashed combination of carefully selected input values.
I've deliberately glossed over the nitty gritty details of exactly how each random number is used to produce random outcomes, which are better covered by other chapters.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="pathfinding.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="map-generation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="pathfinding.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="map-generation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
